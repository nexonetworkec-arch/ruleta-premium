<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NEXO® FORGE - Sistema de Sorteo Ultra Premium</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <style>
        :root { 
            --bg-deep: #000000;
            --gold-bright: #fdf2cf;
            --gold-forge: #c5a059;
            --gold-deep: #7a5c2f;
            --cyan-glow: #00f2ff;
            --obsidian: #0a0a0a;
            --card-bg: rgba(5, 5, 5, 0.98);
        }

        /* CONSTANTES DE MARCA & HERENCIA */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        input, select, textarea, .editable-text, h1, h2, h3, h4, .btn, #winnerName, .dynamic-title {
            color: var(--gold-forge) !important;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 900;
        }

        /* EXCEPCIÓN DE SEGURIDAD */
        input[type="email"], input[type="password"], .no-caps {
            text-transform: none !important;
            letter-spacing: 1px;
            font-weight: 400;
        }
        
        ::placeholder { color: rgba(197, 160, 89, 0.4) !important; text-transform: uppercase; }

        body { 
            background-color: var(--bg-deep); color: var(--gold-forge); font-family: 'Segoe UI', sans-serif; 
            margin: 0; height: 100vh; overflow: hidden; display: flex; align-items: center; justify-content: center;
        }

        /* ATMÓSFERA FORGE */
        body::before {
            content: ''; position: absolute; inset: 0;
            background: radial-gradient(circle at center, #0d1b1e 0%, #000 100%);
            z-index: -1;
        }

        #loading-overlay {
            position: fixed; inset: 0; background: #000; z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        #loginScreen, .app-container { display: none; width: 100%; height: 100%; align-items: center; justify-content: center; flex-direction: column; z-index: 10; }

        input { background: #000; border: 1px solid #222; border-radius: 15px; padding: 18px; text-align: center; font-size: 16px; }

        .btn { padding: 18px 40px; border: none; border-radius: 50px; cursor: pointer; transition: 0.4s; font-size: 12px; }
        .btn-primary { 
            background: linear-gradient(to bottom, var(--gold-bright), var(--gold-forge)); 
            color: #000 !important;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5), 0 0 15px rgba(197, 160, 89, 0.2);
        }

        /* MOTOR VISUAL FORGE */
        .wheel-outer-frame {
            position: relative;
            width: min(88vw, 580px); height: min(88vw, 580px);
            border-radius: 50%;
            background: linear-gradient(145deg, #1a1a1a, #000, #222);
            padding: 10px;
            box-shadow: 0 0 80px rgba(0, 242, 255, 0.1), 0 0 0 6px var(--gold-forge);
            display: flex; align-items: center; justify-content: center;
        }

        .energy-beam {
            position: absolute; width: 140%; height: 1px;
            background: linear-gradient(90deg, transparent, var(--cyan-glow), transparent);
            opacity: 0.2; transform: rotate(45deg); pointer-events: none;
        }

        #wheelCanvas { width: 100%; height: 100%; border-radius: 50%; filter: contrast(1.1); }
        
        .diamond-pointer {
            position: absolute; top: -25px; left: 50%; transform: translateX(-50%); z-index: 100;
            width: 50px; filter: drop-shadow(0 0 15px white);
        }

        #btnSpinCenter { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: min(100px, 20vw); height: min(100px, 20vw); border-radius: 50%;
            border: 2px solid var(--gold-forge); background: radial-gradient(circle at 30% 30%, #444, #000);
            cursor: pointer; z-index: 150; box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; z-index: 9000; backdrop-filter: blur(20px); }
        .modal-content { 
            background: var(--card-bg); padding: 40px; border-radius: 40px; border: 1px solid var(--gold-forge); 
            width: min(500px, 90%); text-align: center; box-shadow: 0 0 50px rgba(0,242,255,0.1);
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div style="width: 40px; height: 40px; border: 3px solid rgba(197,160,89,0.1); border-radius: 50%; border-top-color: var(--gold-forge); animation: spin 0.8s linear infinite;"></div>
        <p style="margin-top: 20px; font-weight: 900; font-size: 10px; letter-spacing: 5px;">NEXO® FORGE ENGINE</p>
    </div>

    <div id="loginScreen">
        <div style="background: var(--card-bg); padding: 50px; border-radius: 40px; border: 1px solid var(--gold-forge); text-align: center; width: min(400px, 90%);">
            <h2 style="font-size: 2.5rem; margin-bottom: 40px;">NEXO®</h2>
            <input type="email" id="authEmail" placeholder="USUARIO" style="width:100%; margin-bottom:15px;">
            <input type="password" id="authPin" placeholder="PASSWORD" style="width:100%; margin-bottom:30px;">
            <button id="btnAuth" class="btn btn-primary" style="width:100%;">INICIAR SESIÓN</button>
        </div>
    </div>

    <div class="app-container" id="appMain">
        <h1 class="dynamic-title" style="color: #fff !important; margin-bottom:30px; font-size: min(2rem, 7vw); text-shadow: 0 0 20px rgba(255,255,255,0.2);"></h1>
        
        <div class="wheel-outer-frame">
            <div class="energy-beam"></div>
            <div class="energy-beam" style="transform: rotate(-45deg);"></div>
            
            <svg class="diamond-pointer" viewBox="0 0 100 120">
                <polygon points="50,120 100,50 50,0 0,50" fill="white" fill-opacity="0.9"/>
                <polygon points="50,120 80,50 50,20 20,50" fill="#c5a059"/>
            </svg>

            <button id="btnSpinCenter">GIRAR</button>
            <canvas id="wheelCanvas" width="1000" height="1000"></canvas>
        </div>
    </div>

    <div id="modalWinner" class="modal"><div class="modal-content">
        <p class="dynamic-title" style="font-size: 12px; color: var(--gold-deep) !important;"></p>
        <div id="winnerName" style="font-size: min(45px, 10vw); margin: 30px 0; color: #fff !important;">---</div>
        <button id="btnFinishWin" class="btn btn-primary" style="width:100%;">RECLAMAR PREMIO</button>
    </div></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCG703rpW4_8U2onJFSw7VfWDNLFofCk8A",
            authDomain: "ruletapremiumbusiness-4db7e.firebaseapp.com",
            projectId: "ruletapremiumbusiness-4db7e",
            storageBucket: "ruletapremiumbusiness-4db7e.firebasestorage.app",
            messagingSenderId: "822563863112",
            appId: "1:822563863112:web:d134d015736e2fafb5367d",
            databaseURL: "https://ruletapremiumbusiness-4db7e-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); const db = firebase.database();

        let currentUser = null;
        let config = { 
            tituloSorteo: "NEXO FORGE",
            prizes: ["Elite Gold", "Obsidian Card", "Nexo Nexus", "Forge Credit", "Aura Premium", "Royal Mint"], 
            modoRegistro: false, isValidated: false
        };

        function syncUI() {
            document.querySelectorAll('.dynamic-title').forEach(el => el.innerText = config.tituloSorteo);
            appWheel.draw();
        }

        auth.onAuthStateChanged(user => {
            currentUser = user;
            if(user) {
                db.ref(`users/${user.uid}/config`).on('value', snap => {
                    if(snap.exists()) config = {...config, ...snap.val()};
                    syncUI();
                });
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appMain').style.display = 'flex';
            } else {
                document.getElementById('appMain').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
            }
            document.getElementById('loading-overlay').style.display = 'none';
        });

        class Wheel {
            constructor() {
                this.canvas = document.getElementById('wheelCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.angle = 0; this.isSpinning = false;
            }
            draw() {
                const cx = 500, cy = 500, r = 480, n = config.prizes.length;
                const slice = (Math.PI*2)/n;
                this.ctx.clearRect(0,0,1000,1000);
                
                config.prizes.forEach((p, i) => {
                    this.ctx.save();
                    this.ctx.beginPath();
                    this.ctx.moveTo(cx,cy);
                    
                    let grad = this.ctx.createRadialGradient(cx, cy, 100, cx, cy, r);
                    if(i % 2 === 0) {
                        grad.addColorStop(0, '#c5a059'); grad.addColorStop(0.5, '#7a5c2f'); grad.addColorStop(1, '#fdf2cf');
                    } else {
                        grad.addColorStop(0, '#1a1a1a'); grad.addColorStop(1, '#000');
                    }
                    
                    this.ctx.fillStyle = grad;
                    this.ctx.arc(cx, cy, r, this.angle+i*slice, this.angle+(i+1)*slice);
                    this.ctx.fill();
                    
                    // LÍNEAS DE CORTE CIAN SUTIL
                    this.ctx.strokeStyle = 'rgba(0, 242, 255, 0.05)';
                    this.ctx.lineWidth = 2;
                    this.ctx.stroke();

                    this.ctx.translate(cx,cy);
                    this.ctx.rotate(this.angle+i*slice+slice/2);
                    this.ctx.textAlign="right";
                    this.ctx.font = "900 35px Segoe UI";
                    this.ctx.fillStyle = i % 2 === 0 ? "#000" : "#c5a059";
                    this.ctx.fillText(p.toUpperCase(), r-60, 12);
                    this.ctx.restore();
                });

                // NÚCLEO CENTRAL
                this.ctx.beginPath();
                this.ctx.arc(cx,cy, 70, 0, Math.PI*2);
                this.ctx.fillStyle = '#000'; this.ctx.fill();
                this.ctx.strokeStyle = '#c5a059'; this.ctx.lineWidth = 4; this.ctx.stroke();
            }

            handleSpinClick() {
                if(this.isSpinning) return;
                if(config.modoRegistro && !config.isValidated) { alert("REGISTRO REQUERIDO"); return; }
                this.executeSpin();
            }

            executeSpin() {
                this.isSpinning = true;
                const total = (Math.PI*2*10) + (Math.random()*Math.PI*2);
                const duration = 5000; const start = performance.now();
                const anim = (now) => {
                    const t = Math.min((now-start)/duration, 1);
                    const ease = 1 - Math.pow(1-t, 4);
                    this.angle = total * ease;
                    this.draw();
                    if(t < 1) requestAnimationFrame(anim);
                    else this.finish();
                };
                requestAnimationFrame(anim);
            }

            finish() {
                this.isSpinning = false;
                const n = config.prizes.length;
                const deg = (this.angle * 180 / Math.PI) % 360;
                const idx = n - 1 - Math.floor(deg/(360/n));
                const prize = config.prizes[idx];
                document.getElementById('winnerName').innerText = prize;
                document.getElementById('modalWinner').style.display = 'flex';
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#c5a059', '#00f2ff'] });
                document.getElementById('btnFinishWin').onclick = () => {
                    document.getElementById('modalWinner').style.display = 'none';
                    if(config.modoRegistro) config.isValidated = false;
                };
            }
        }

        const appWheel = new Wheel();
        document.getElementById('btnSpinCenter').onclick = () => appWheel.handleSpinClick();

        document.getElementById('btnAuth').onclick = () => {
            const email = document.getElementById('authEmail').value;
            const pin = document.getElementById('authPin').value;
            auth.signInWithEmailAndPassword(email, pin).catch(err => alert("ERROR: " + err.message));
        };
    </script>
    
    </body>
            </html>
