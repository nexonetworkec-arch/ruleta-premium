<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NEXOÂ® Business Pro - Sistema de Sorteo Premium</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { 
            --bg-color: #0a0a0a;
            --card-bg: #161616; 
            --gold: #d4af37; 
            --white: #ffffff; 
            --danger: #ff4d4d; 
            --gray: #222;
        }
        
        /* BLOQUEO DE PANTALLAZO LOGIN */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .spinner {
            width: 50px; height: 50px; border: 3px solid rgba(212,175,55,0.3);
            border-radius: 50%; border-top-color: var(--gold);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color); color: var(--white);
            margin: 0; overflow: hidden; height: 100vh;
            display: flex; flex-direction: column;
        }

        /* Estilos App Principal */
        #auth-container, #app-container { display: none; width: 100%; height: 100vh; }
        
        .side-panel {
            background: var(--card-bg); padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
            border-bottom: 1px solid #333; z-index: 100;
        }

        .wheel-container {
            flex: 1; display: flex; align-items: center; justify-content: center;
            position: relative; overflow: hidden; padding: 20px;
        }

        canvas { max-width: 95vw; max-height: 95vw; border-radius: 50%; box-shadow: 0 0 50px rgba(0,0,0,0.5); }

        /* BotÃ³n GIRAR / LOGO */
        #btnSpinCenter {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 80px; height: 80px;
            background: var(--white); border-radius: 50%;
            border: 4px solid #000; cursor: pointer;
            z-index: 10; display: flex; align-items: center; justify-content: center;
            font-weight: 900; color: #000; text-align: center;
            transition: transform 0.1s; font-size: 14px;
            background-size: contain; background-repeat: no-repeat; background-position: center;
        }

        #btnSpinCenter:active { transform: translate(-50%, -50%) scale(0.9); }

        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center;
            padding: 20px;
        }

        .btn {
            padding: 12px 20px; border-radius: 8px; border: none;
            font-weight: 600; cursor: pointer; width: 100%;
            text-transform: uppercase; letter-spacing: 1px;
            transition: all 0.3s;
        }

        .btn-primary { background: var(--gold); color: #000; }
        .btn-secondary { background: transparent; border: 1px solid #444; color: #fff; }

        /* Panel Admin */
        #modalAdmin .modal-content {
            background: #111; width: 100%; max-width: 800px; max-height: 90vh;
            overflow-y: auto; border: 1px solid var(--gold); border-radius: 12px; padding: 20px;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; color: #ccc; font-size: 12px; }
        th, td { border: 1px solid #333; padding: 10px; text-align: left; }
        th { background: #1a1a1a; color: var(--gold); }

        @media (max-width: 768px) {
            .side-panel { order: 2; flex-direction: row; flex-wrap: wrap; padding: 10px; }
            .side-panel .btn { flex: 1; font-size: 10px; padding: 8px; min-width: 80px; }
            .wheel-container { order: 1; }
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <p style="color: var(--gold); margin-top: 15px; font-weight: bold;">NEXOÂ® Business Pro</p>
    </div>

    <div id="auth-container">
        <div style="max-width: 400px; margin: 100px auto; padding: 30px; background: var(--card-bg); border-radius: 15px; text-align: center;">
            <h2 style="color: var(--gold);">BIENVENIDO</h2>
            <input type="email" id="email" placeholder="Email" style="width:100%; padding:12px; margin:10px 0; background:#222; border:1px solid #444; color:#fff; border-radius:8px;">
            <input type="password" id="password" placeholder="ContraseÃ±a" style="width:100%; padding:12px; margin:10px 0; background:#222; border:1px solid #444; color:#fff; border-radius:8px;">
            <button class="btn btn-primary" id="btnLogin">Iniciar SesiÃ³n</button>
            <p id="auth-error" style="color:var(--danger); font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <div id="app-container">
        <div class="side-panel">
            <button id="btnAdminMaster" class="btn btn-secondary" style="display:none; color:var(--gold); border-color:var(--gold);">ðŸ‘‘ PANEL ADMIN</button>
            <button id="btnBranding" class="btn btn-secondary" style="display:none;">âœ¨ MARCA</button>
            <button id="btnResetApp" class="btn btn-secondary">ðŸ”„ REINICIAR</button>
            <button id="btnLogout" class="btn btn-secondary" style="color:var(--danger);">CERRAR SESIÃ“N</button>
        </div>

        <div class="wheel-container">
            <canvas id="wheelCanvas" width="500" height="500"></canvas>
            <div id="btnSpinCenter">GIRAR</div>
        </div>
    </div>

    <div id="modalAdmin" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--gold);">MONITOR ADMINISTRATIVO</h2>
            <div id="monitorLive" style="background:#222; padding:10px; border-radius:8px; margin-bottom:15px; font-size:13px;">
                <strong>ÃšLTIMO GANADOR:</strong> <span id="liveWinner">Ninguno</span>
            </div>
            <table id="adminTable">
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Nivel</th>
                        <th>Estado</th>
                        <th>AcciÃ³n</th>
                    </tr>
                </thead>
                <tbody id="adminTableBody"></tbody>
            </table>
            <button class="btn btn-secondary" style="margin-top:20px;" onclick="closeModal('modalAdmin')">Cerrar</button>
        </div>
    </div>

    <script>
        // CONFIGURACIÃ“N FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyC...", // Tu API Key aquÃ­
            authDomain: "tu-app.firebaseapp.com",
            databaseURL: "https://tu-app-default-rtdb.firebaseio.com",
            projectId: "tu-app",
            storageBucket: "tu-app.appspot.com",
            messagingSenderId: "...",
            appId: "..."
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let currentUser = null;
        let config = null;

        // ELEMENTOS DOM
        const appContainer = document.getElementById('app-container');
        const authContainer = document.getElementById('auth-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const btnSpin = document.getElementById('btnSpinCenter');

        // --- LÃ“GICA DE AUTENTICACIÃ“N Y CARGA ---
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            if (user) {
                // Cargar configuraciÃ³n de usuario
                const snapshot = await db.ref(`users/${user.uid}/config`).once('value');
                config = snapshot.val() || { level: 'free' };
                
                // Aplicar estado inicial
                applyLogoToWheel(config.customLogoURL);
                checkAdminAccess(user.uid);
                checkBrandingAccess();
                
                // Mostrar App
                authContainer.style.display = 'none';
                appContainer.style.display = 'flex';
                updatePresence(user.uid);
            } else {
                appContainer.style.display = 'none';
                authContainer.style.display = 'block';
            }
            loadingOverlay.style.display = 'none'; // Quitamos el velo solo al confirmar estado
        });

        // --- MOTOR DE LA RULETA (SANEADO) ---
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const segments = ["PREMIO 1", "PREMIO 2", "SIGUE INTENTANDO", "PREMIO 3", "BONO", "SUERTE"];
        let startAngle = 0;
        const arc = Math.PI / (segments.length / 2);
        let spinTimeout = null;
        let spinAngleStart = 0;
        let spinTime = 0;
        let spinTimeTotal = 0;

        function drawWheel() {
            ctx.clearRect(0,0,500,500);
            for(let i = 0; i < segments.length; i++) {
                const angle = startAngle + i * arc;
                ctx.fillStyle = i % 2 === 0 ? "#111" : "#d4af37";
                ctx.beginPath();
                ctx.arc(250, 250, 240, angle, angle + arc, false);
                ctx.lineTo(250, 250);
                ctx.fill();
                ctx.save();
                ctx.fillStyle = i % 2 === 0 ? "#fff" : "#000";
                ctx.translate(250 + Math.cos(angle + arc / 2) * 180, 250 + Math.sin(angle + arc / 2) * 180);
                ctx.rotate(angle + arc / 2 + Math.PI / 2);
                ctx.fillText(segments[i], -ctx.measureText(segments[i]).width / 2, 0);
                ctx.restore();
            }
        }

        btnSpin.onclick = () => {
            spinAngleStart = Math.random() * 10 + 10;
            spinTime = 0;
            spinTimeTotal = Math.random() * 3 + 4 * 1000;
            rotateWheel();
        };

        function rotateWheel() {
            spinTime += 30;
            if(spinTime >= spinTimeTotal) {
                stopRotateWheel();
                return;
            }
            const spinAngle = spinAngleStart - easeOut(spinTime, 0, spinAngleStart, spinTimeTotal);
            startAngle += (spinAngle * Math.PI / 180);
            drawWheel();
            spinTimeout = setTimeout(rotateWheel, 30);
        }

        function stopRotateWheel() {
            clearTimeout(spinTimeout);
            const degrees = startAngle * 180 / Math.PI + 90;
            const arcd = arc * 180 / Math.PI;
            const index = Math.floor((360 - degrees % 360) / arcd);
            const winner = segments[index];
            showWinner(winner);
        }

        function easeOut(t, b, c, d) {
            const ts = (t /= d) * t;
            const tc = ts * t;
            return b + c * (tc + -3 * ts + 3 * t);
        }

        function showWinner(prize) {
            alert("Â¡GANASTE: " + prize + "!");
            // MONITOR EN TIEMPO REAL
            if(currentUser) {
                db.ref('live_monitor/last_spin').set({
                    user: currentUser.email,
                    prize: prize,
                    time: new Date().toLocaleTimeString()
                });
            }
        }

        // --- FUNCIONES DE ESTABILIDAD (CORREGIDAS) ---
        function applyLogoToWheel(url) {
            if (url && url.trim() !== "") {
                btnSpin.style.backgroundImage = `url(${url})`;
                btnSpin.style.color = "transparent";
                btnSpin.innerText = "";
            } else {
                btnSpin.style.backgroundImage = "none";
                btnSpin.style.color = "#000";
                btnSpin.innerText = "GIRAR";
            }
        }

        async function checkAdminAccess(uid) {
            const adminSnap = await db.ref(`admins/${uid}`).once('value');
            if(adminSnap.exists()) {
                const btnAdmin = document.getElementById('btnAdminMaster');
                btnAdmin.style.display = 'flex';
                btnAdmin.onclick = () => {
                    document.getElementById('modalAdmin').style.display = 'flex';
                    updateAdminTable();
                };
                
                // Escuchar monitor en vivo
                db.ref('live_monitor/last_spin').on('value', s => {
                    const data = s.val();
                    if(data) document.getElementById('liveWinner').innerText = `${data.user} ganÃ³ ${data.prize} (${data.time})`;
                });
            }
        }

        function checkBrandingAccess() {
            if(config && config.level !== 'free') {
                const btnB = document.getElementById('btnBranding');
                btnB.style.display = 'flex';
                btnB.onclick = () => {
                    const url = prompt("URL del Logo (PNG):", config.customLogoURL || "");
                    if(url !== null) db.ref(`users/${currentUser.uid}/config/customLogoURL`).set(url).then(() => location.reload());
                };
            }
        }

        function updatePresence(uid) {
            const statusRef = db.ref(`users/${uid}/status`);
            db.ref('.info/connected').on('value', (snap) => {
                if (snap.val() === false) return;
                statusRef.onDisconnect().set('offline').then(() => statusRef.set('online'));
            });
        }

        function updateAdminTable() {
            db.ref('users').once('value', (snap) => {
                const users = snap.val();
                const tbody = document.getElementById('adminTableBody');
                tbody.innerHTML = '';
                for(let id in users) {
                    const u = users[id];
                    const tr = `<tr>
                        <td>${u.email || id}</td>
                        <td>${u.config?.level || 'free'}</td>
                        <td>${u.status || 'offline'}</td>
                        <td><button onclick="setVIP('${id}')">Subir VIP</button></td>
                    </tr>`;
                    tbody.innerHTML += tr;
                }
            });
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // Login Manual
        document.getElementById('btnLogin').onclick = () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(e, p).catch(err => {
                document.getElementById('auth-error').innerText = "Error: " + err.message;
            });
        };

        document.getElementById('btnLogout').onclick = () => auth.signOut();
        document.getElementById('btnResetApp').onclick = () => location.reload();

        drawWheel();
    </script>
</body>
</html>
