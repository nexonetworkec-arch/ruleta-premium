<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NEXO¬Æ Business Pro - Sistema de Sorteo Premium</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { 
            --bg-color: #0a0a0a;
            --card-bg: #161616; 
            --gold: #d4af37; 
            --white: #ffffff; 
            --danger: #ff4d4d; 
            --gray: #222;
        }
        
        * { box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--white);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        #app-container {
            width: 100%;
            max-width: 450px;
            height: 100vh;
            position: relative;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
        }

        /* --- LOGIN & AUTH --- */
        .screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: none;
            flex-direction: column;
            padding: 40px 25px;
            z-index: 10;
            background: var(--bg-color);
        }

        .screen.active { display: flex; }

        .logo-container {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo-nexo {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -1px;
            color: var(--gold);
        }

        .logo-nexo span { color: var(--white); font-weight: 300; }

        .auth-card {
            background: var(--card-bg);
            padding: 30px 20px;
            border-radius: 20px;
            border: 1px solid #333;
        }

        .auth-card h2 { margin-top: 0; font-size: 1.4rem; margin-bottom: 10px; }
        .auth-card p { color: #888; font-size: 0.9rem; margin-bottom: 25px; }

        input {
            width: 100%;
            background: #222;
            border: 1px solid #333;
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .btn-primary {
            width: 100%;
            background: var(--gold);
            color: black;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-primary:active { transform: scale(0.98); }

        /* --- MAIN INTERFACE --- */
        #appMain { padding: 0; }

        header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #1a1a1a;
            padding: 8px 15px;
            border-radius: 30px;
            border: 1px solid #333;
        }

        .level-tag {
            font-size: 10px;
            text-transform: uppercase;
            font-weight: 900;
            padding: 2px 8px;
            border-radius: 4px;
            background: var(--gold);
            color: black;
        }

        /* --- WHEEL ENGINE --- */
        .wheel-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .wheel-container {
            position: relative;
            width: 320px;
            height: 320px;
            margin-bottom: 30px;
        }

        #wheelCanvas {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.2);
            border: 8px solid #1a1a1a;
        }

        .wheel-pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 45px;
            z-index: 5;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5));
        }

        /* --- CONTROLS --- */
        .actions-bar {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn-action {
            background: #1a1a1a;
            border: 1px solid #333;
            color: white;
            padding: 12px;
            border-radius: 12px;
            font-size: 13px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        /* --- MODALS --- */
        .modal {
            position: fixed;
            bottom: -100%;
            left: 0;
            width: 100%;
            height: 90%;
            background: #0f0f0f;
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
            z-index: 100;
            transition: bottom 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            padding: 30px 20px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.8);
        }

        .modal.active { bottom: 0; }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .close-modal { font-size: 24px; color: #555; cursor: pointer; }

        /* --- ADMIN MASTER --- */
        #adminPanel {
            background: #050505;
            z-index: 200;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #111;
            padding: 15px;
            border-radius: 12px;
            border-left: 3px solid var(--gold);
        }

        .stat-card span { display: block; font-size: 10px; color: #666; text-transform: uppercase; }
        .stat-card b { font-size: 18px; color: var(--gold); }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        
        /* Anti-flicker para el login */
        #authScreen { display: flex; }
        body.auth-checked #authScreen { display: none; }
        body.auth-checked #appMain { display: flex; }

    </style>
</head>
<body>

    <div id="app-container">
        
        <div id="authScreen" class="screen active">
            <div class="logo-container">
                <div class="logo-nexo">NEXO<span>¬Æ</span></div>
                <div style="font-size: 10px; color: var(--gold); letter-spacing: 2px; font-weight: 700;">BUSINESS PRO</div>
            </div>

            <div class="auth-card">
                <h2 id="authTitle">Bienvenido</h2>
                <p id="authSubtitle">Ingresa tu PIN de acceso empresarial para continuar.</p>
                
                <input type="email" id="email" placeholder="Correo corporativo" style="display:none;">
                <input type="password" id="pin" placeholder="PIN de Seguridad">
                
                <button id="btnAuth" class="btn-primary">ACCEDER AL SISTEMA</button>
                
                <div style="margin-top: 20px; text-align: center;">
                    <span id="toggleAuth" style="color: #666; font-size: 12px; cursor: pointer;">¬øNo tienes cuenta? Solicitar acceso</span>
                </div>
            </div>
        </div>

        <div id="appMain" class="screen">
            <header>
                <div class="logo-nexo" style="font-size: 20px;">NEXO<span>¬Æ</span></div>
                <div class="user-badge">
                    <span id="userName" style="font-size: 12px; font-weight: 600;">Usuario</span>
                    <span id="userLevel" class="level-tag">FREE</span>
                </div>
            </header>

            <div class="wheel-section">
                <h1 id="appTitle" style="margin: 0 0 20px 0; font-size: 22px; text-align: center;">Sorteo Mensual</h1>
                
                <div class="wheel-container">
                    <svg class="wheel-pointer" viewBox="0 0 40 45">
                        <path d="M20 45L0 0H40L20 45Z" fill="#d4af37"/>
                    </svg>
                    <canvas id="wheelCanvas" width="600" height="600"></canvas>
                </div>

                <div id="remainingSpins" style="font-size: 13px; color: #666; margin-bottom: 20px;">
                    Giros disponibles: <span style="color: white; font-weight: 700;">0</span>
                </div>

                <button id="btnSpin" class="btn-primary" style="width: 280px; box-shadow: 0 10px 20px rgba(212,175,55,0.3);">
                    GIRAR AHORA
                </button>
            </div>

            <div class="actions-bar">
                <button class="btn-action" onclick="appWheel.showModal('modalConfig')">
                    <span style="font-size: 18px;">‚öôÔ∏è</span>
                    Configurar
                </button>
                <button class="btn-action" onclick="appWheel.showModal('modalHistory')">
                    <span style="font-size: 18px;">üìä</span>
                    Historial
                </button>
                <button id="btnAdminTrigger" class="btn-action hidden" onclick="appWheel.showModal('adminPanel')">
                    <span style="font-size: 18px;">üëë</span>
                    Admin Master
                </button>
                <button class="btn-action" id="btnLogout">
                    <span style="font-size: 18px;">üö™</span>
                    Salir
                </button>
            </div>
        </div>

        <div id="modalConfig" class="modal">
            <div class="modal-header">
                <h3>Configuraci√≥n</h3>
                <span class="close-modal" onclick="appWheel.closeModal('modalConfig')">&times;</span>
            </div>
            
            <label style="font-size: 12px; color: #666;">T√≠tulo del Sorteo</label>
            <input type="text" id="inputTitle" placeholder="Ej: Premios de Navidad">
            
            <label style="font-size: 12px; color: #666;">Opciones (una por l√≠nea)</label>
            <textarea id="inputOptions" style="width:100%; height: 120px; background: #222; border: 1px solid #333; color: white; border-radius: 12px; padding: 10px; margin-top: 5px;"></textarea>
            
            <div style="margin-top: 20px;">
                <label style="display: flex; align-items: center; gap: 10px; font-size: 14px;">
                    <input type="checkbox" id="checkAutoDelete" style="width: 20px; margin: 0;"> 
                    Auto-eliminar ganador
                </label>
            </div>

            <button onclick="appWheel.saveSettings()" class="btn-primary" style="margin-top: 30px;">GUARDAR CAMBIOS</button>
        </div>

        <div id="modalHistory" class="modal">
            <div class="modal-header">
                <h3>Resultados</h3>
                <span class="close-modal" onclick="appWheel.closeModal('modalHistory')">&times;</span>
            </div>
            <div id="historyList" style="max-height: 60%; overflow-y: auto; margin-bottom: 20px;">
                </div>
            <button id="btnExport" class="btn-primary" style="background: #222; color: white; border: 1px solid #444;">
                DESCARGAR REPORTE (JPG)
            </button>
        </div>

        <div id="adminPanel" class="modal">
            <div class="modal-header">
                <h3 style="color: var(--gold);">üëë ADMIN MASTER</h3>
                <span class="close-modal" onclick="appWheel.closeModal('adminPanel')">&times;</span>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card"><span>Usuarios</span><b id="statUsers">0</b></div>
                <div class="stat-card"><span>Giros Hoy</span><b id="statSpins">0</b></div>
            </div>

            <div id="usersList" style="overflow-y: auto; height: 300px;">
                </div>
        </div>

    </div>

    <audio id="sndSpin" src="https://assets.mixkit.co/active_storage/sfx/2005/2005-preview.mp3"></audio>
    <audio id="sndWin" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3"></audio>

    <script>
        // --- CONFIGURACI√ìN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAs-DEMO-ONLY",
            authDomain: "nexo-premium.firebaseapp.com",
            databaseURL: "https://nexo-premium-default-rtdb.firebaseio.com",
            projectId: "nexo-premium",
            storageBucket: "nexo-premium.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- MOTOR PRINCIPAL NEXO¬Æ ---
        const appWheel = {
            isSpinning: false,
            options: ["Premio 1", "Premio 2", "Premio 3", "Premio 4"],
            colors: ['#d4af37', '#1a1a1a', '#c0c0c0', '#111111'],
            currentRotation: 0,
            userData: null,

            init() {
                this.canvas = document.getElementById('wheelCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.setupListeners();
                this.draw();
            },

            setupListeners() {
                document.getElementById('btnSpin').addEventListener('click', () => this.spin());
                document.getElementById('btnLogout').addEventListener('click', () => auth.signOut());
                
                // Toggle Login/Registro
                document.getElementById('toggleAuth').addEventListener('click', () => {
                    const isLogin = document.getElementById('authTitle').innerText === "Bienvenido";
                    document.getElementById('authTitle').innerText = isLogin ? "Crear Cuenta" : "Bienvenido";
                    document.getElementById('authSubtitle').innerText = isLogin ? "Reg√≠strate para gestionar tus sorteos." : "Ingresa tu PIN de acceso empresarial.";
                    document.getElementById('email').style.display = isLogin ? "block" : "none";
                    document.getElementById('btnAuth').innerText = isLogin ? "REGISTRARSE" : "ACCEDER AL SISTEMA";
                    document.getElementById('toggleAuth').innerText = isLogin ? "¬øYa tienes cuenta? Ingresar" : "¬øNo tienes cuenta? Solicitar acceso";
                });

                document.getElementById('btnAuth').addEventListener('click', () => this.handleAuth());
            },

            async handleAuth() {
                const email = document.getElementById('email').value || `user_${Date.now()}@nexo.pro`;
                const pin = document.getElementById('pin').value;
                const isLogin = document.getElementById('authTitle').innerText === "Bienvenido";

                if(pin.length < 4) return alert("El PIN debe tener al menos 4 d√≠gitos");

                try {
                    if(isLogin) {
                        // Simulaci√≥n de b√∫squeda de email por PIN si fuera necesario, 
                        // pero aqu√≠ usamos Firebase Auth directamente por simplicidad funcional
                        await auth.signInWithEmailAndPassword(email, pin);
                    } else {
                        const userCred = await auth.createUserWithEmailAndPassword(email, pin);
                        await db.ref(`users/${userCred.user.uid}`).set({
                            name: "Nuevo Consultor",
                            level: "free",
                            spinsLeft: 10,
                            settings: {
                                title: "Mi Sorteo Nexo",
                                options: "Premio A\nPremio B\nPremio C",
                                autoDelete: false
                            }
                        });
                    }
                } catch(e) { alert("Error: " + e.message); }
            },

            draw() {
                const { ctx, canvas, options, colors } = this;
                const center = canvas.width / 2;
                const arc = Math.PI * 2 / options.length;

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                options.forEach((opt, i) => {
                    const angle = this.currentRotation + i * arc;
                    
                    // Segmento
                    ctx.beginPath();
                    ctx.fillStyle = colors[i % colors.length];
                    ctx.moveTo(center, center);
                    ctx.arc(center, center, center - 10, angle, angle + arc);
                    ctx.lineTo(center, center);
                    ctx.fill();
                    ctx.stroke();

                    // Texto
                    ctx.save();
                    ctx.translate(center, center);
                    ctx.rotate(angle + arc / 2);
                    ctx.textAlign = "right";
                    ctx.fillStyle = i % 2 === 0 ? "black" : "white";
                    ctx.font = "bold 24px Arial";
                    ctx.fillText(opt.substring(0, 15), center - 40, 10);
                    ctx.restore();
                });

                // Centro decorativo
                ctx.beginPath();
                ctx.arc(center, center, 40, 0, Math.PI * 2);
                ctx.fillStyle = "#000";
                ctx.fill();
                ctx.strokeStyle = varColor('--gold');
                ctx.lineWidth = 5;
                ctx.stroke();
            },

            async spin() {
                if(this.isSpinning || this.userData.spinsLeft <= 0) {
                    if(this.userData.spinsLeft <= 0) alert("Has agotado tus giros. Actualiza a PRO.");
                    return;
                }

                this.isSpinning = true;
                document.getElementById('sndSpin').play();

                const extraRounds = 5 + Math.random() * 5;
                const totalRotation = extraRounds * Math.PI * 2;
                const duration = 4000;
                const start = performance.now();

                const animate = (time) => {
                    const elapsed = time - start;
                    const progress = Math.min(elapsed / duration, 1);
                    const easeOut = 1 - Math.pow(1 - progress, 3);
                    
                    this.currentRotation = easeOut * totalRotation;
                    this.draw();

                    if(progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        this.finalizeSpin();
                    }
                };
                requestAnimationFrame(animate);
            },

            finalizeSpin() {
                this.isSpinning = false;
                document.getElementById('sndWin').play();
                
                const arc = Math.PI * 2 / this.options.length;
                const winningIndex = Math.floor(((Math.PI * 2) - (this.currentRotation % (Math.PI * 2))) / arc) % this.options.length;
                const winner = this.options[winningIndex];

                // Registrar en DB
                const newSpinCount = this.userData.spinsLeft - 1;
                db.ref(`users/${auth.currentUser.uid}/spinsLeft`).set(newSpinCount);
                
                const historyRef = db.ref(`users/${auth.currentUser.uid}/history`).push();
                historyRef.set({
                    prize: winner,
                    date: new Date().toLocaleString()
                });

                alert("¬°GANADOR: " + winner + "!");

                if(this.userData.settings.autoDelete) {
                    this.options.splice(winningIndex, 1);
                    this.saveOptionsDirectly();
                }
            },

            showModal(id) {
                document.getElementById(id).classList.add('active');
                if(id === 'modalConfig') {
                    document.getElementById('inputTitle').value = this.userData.settings.title;
                    document.getElementById('inputOptions').value = this.userData.settings.options;
                    document.getElementById('checkAutoDelete').checked = this.userData.settings.autoDelete;
                }
                if(id === 'modalHistory') this.renderHistory();
                if(id === 'adminPanel') this.loadAdminData();
            },

            closeModal(id) {
                document.getElementById(id).classList.remove('active');
            },

            saveSettings() {
                const updates = {
                    'settings/title': document.getElementById('inputTitle').value,
                    'settings/options': document.getElementById('inputOptions').value,
                    'settings/autoDelete': document.getElementById('checkAutoDelete').checked
                };
                db.ref(`users/${auth.currentUser.uid}`).update(updates);
                this.closeModal('modalConfig');
            },

            saveOptionsDirectly() {
                db.ref(`users/${auth.currentUser.uid}/settings/options`).set(this.options.join('\n'));
            },

            renderHistory() {
                const container = document.getElementById('historyList');
                container.innerHTML = "";
                db.ref(`users/${auth.currentUser.uid}/history`).limitToLast(20).once('value', snap => {
                    snap.forEach(child => {
                        const data = child.val();
                        container.innerHTML = `
                            <div style="background:#222; padding:10px; border-radius:8px; margin-bottom:5px; font-size:12px; display:flex; justify-content:space-between;">
                                <span>${data.prize}</span>
                                <span style="color:#666;">${data.date}</span>
                            </div>
                        ` + container.innerHTML;
                    });
                });
            },

            loadAdminData() {
                db.ref('users').once('value', snap => {
                    document.getElementById('statUsers').innerText = snap.numChildren();
                    const list = document.getElementById('usersList');
                    list.innerHTML = "";
                    snap.forEach(userSnap => {
                        const u = userSnap.val();
                        list.innerHTML += `
                            <div style="padding:10px; border-bottom:1px solid #222; font-size:12px;">
                                <b>${u.name}</b> (${u.level})<br>
                                <span style="color:#666">Giros: ${u.spinsLeft}</span>
                            </div>
                        `;
                    });
                });
            }
        };

        // --- SISTEMA DE OBSERVACI√ìN DE DATOS (REALTIME) ---
        auth.onAuthStateChanged(user => {
            if(user) {
                db.ref(`users/${user.uid}`).on('value', snap => {
                    const data = snap.val();
                    if(!data) return;
                    
                    appWheel.userData = data;
                    appWheel.options = data.settings.options.split('\n').filter(o => o.trim() !== "");
                    
                    document.getElementById('userName').innerText = data.name;
                    document.getElementById('userLevel').innerText = data.level;
                    document.getElementById('appTitle').innerText = data.settings.title;
                    document.getElementById('remainingSpins').querySelector('span').innerText = data.spinsLeft;
                    
                    // Admin Check
                    db.ref(`admins/${user.uid}`).once('value', adminSnap => {
                        if(adminSnap.exists()) {
                            document.getElementById('btnAdminTrigger').classList.remove('hidden');
                        }
                    });

                    document.body.classList.add('auth-checked');
                    appWheel.draw();
                });
            } else {
                document.body.classList.remove('auth-checked');
            }
        });

        // Helper para obtener variables CSS
        function varColor(name) {
            return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        }

        appWheel.init();

        // --- EXPORTACI√ìN DE RESULTADOS ---
        document.getElementById('btnExport').addEventListener('click', () => {
            const history = document.getElementById('historyList');
            html2canvas(history, { backgroundColor: '#000' }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Sorteo_Nexo_${Date.now()}.jpg`;
                link.href = canvas.toDataURL("image/jpeg");
                link.click();
            });
        });

        // --- INTERCEPCI√ìN DE SEGURIDAD (ANTI-INYECCI√ìN) ---
        (function() {
            const btnAuth = document.getElementById('btnAuth');
            if (btnAuth) {
                const originalAuthClick = btnAuth.onclick;
                btnAuth.onclick = async function(e) {
                    // Verificaci√≥n extra de integridad previa al proceso de auth
                    if (originalAuthClick) {
                        try {
                            await originalAuthClick.call(btnAuth, e);
                        } catch (err) {
                            alert("Error: " + err.message);
                        }
                    }
                };
            }
        })();

        // --- INYECCI√ìN ADITIVA: MONITOREO DE SESIONES Y PRESENCIA (ADMIN MASTER) ---
        (function() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const statusRef = db.ref(`users/${user.uid}/status`);
                    const loginRef = db.ref(`users/${user.uid}/loginLogs`).push();
                    const now = new Date().toLocaleString();
                    
                    await loginRef.set({ timestamp: now });
                    
                    const onlineStatus = { state: 'online', last_changed: firebase.database.ServerValue.TIMESTAMP };
                    const offlineStatus = { state: 'offline', last_changed: firebase.database.ServerValue.TIMESTAMP };

                    db.ref('.info/connected').on('value', (snap) => {
                        if (snap.val() === false) return;
                        statusRef.onDisconnect().set(offlineStatus).then(() => {
                            statusRef.set(onlineStatus);
                        });
                    });
                }
            });
        })();

        // =========================================================================
        // --- INYECCI√ìN ADITIVA: SISTEMA DE LOGS DETALLADO (LOGS & MONITORING) ---
        // Insertado al final para Integridad Estructural.
        // Se conecta mediante wrappers a las funciones existentes.
        // =========================================================================
        (function() {
            // Referencia centralizada para logs
            const getNexoLogger = () => {
                const user = auth.currentUser;
                return user ? db.ref(`users/${user.uid}/detailed_logs`) : null;
            };

            // 1. Monitoreo de Seguridad y Bloqueos (Intentos de giro)
            const originalSpin = appWheel.spin.bind(appWheel);
            appWheel.spin = async function() {
                const logger = getNexoLogger();
                if (this.userData && this.userData.spinsLeft <= 0) {
                    if (logger) {
                        logger.push({
                            event: 'SPIN_BLOCKED',
                            reason: 'Insufficient spins',
                            level: this.userData.level,
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        });
                    }
                }
                return originalSpin();
            };

            // 2. Auditor√≠a de Cambios de Configuraci√≥n
            const originalSaveSettings = appWheel.saveSettings.bind(appWheel);
            appWheel.saveSettings = function() {
                const logger = getNexoLogger();
                const oldSettings = JSON.parse(JSON.stringify(this.userData.settings));
                const newTitle = document.getElementById('inputTitle').value;
                const newOptions = document.getElementById('inputOptions').value;

                if (logger) {
                    logger.push({
                        event: 'CONFIG_CHANGE',
                        details: {
                            from_title: oldSettings.title,
                            to_title: newTitle,
                            options_changed: oldSettings.options !== newOptions
                        },
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                }
                return originalSaveSettings();
            };

            // 3. Captura de Errores de Sistema (html2canvas y otros)
            window.addEventListener('error', function(event) {
                const logger = getNexoLogger();
                if (logger) {
                    logger.push({
                        event: 'SYSTEM_ERROR',
                        message: event.message,
                        source: event.filename,
                        lineno: event.lineno,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            });

            // 4. Metadata de Dispositivo al Login
            auth.onAuthStateChanged(user => {
                if (user) {
                    const logger = db.ref(`users/${user.uid}/session_metadata`);
                    logger.set({
                        userAgent: navigator.userAgent,
                        platform: navigator.platform,
                        language: navigator.language,
                        last_active: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            });

            console.log("NEXO¬Æ Logging System: Active & Attached.");
        })();
    </script>
</body>
</html>
